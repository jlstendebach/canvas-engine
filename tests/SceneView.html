<!DOCTYPE html>
<html lang="en" >
  <!--[ HEAD ]===============================================================-->
  <head>
    <!--[ libs ]--------------------------------------------------------------->
    <meta charset="utf-8"/>    
    <script src="lib/engine.2020.08.12.js"></script>
    
    <!--[ style ]-------------------------------------------------------------->
    <style>
      #main-canvas {
        border: 1px solid black;
      }
    </style>
  </head>
  
  <!--[ BODY ]===============================================================-->
  <body style="padding:0; margin:0; border:0;">
    <canvas id="main-canvas" style="width:100vw; height:100vh;">
      Your browser does not support HTML5 canvas.
    </canvas>
    <div id="output-div">
    </div>
  
    <!--[ JS ]===============================================================-->
    <script>
      window.addEventListener("load", function() {
        window.removeEventListener("load", this);

        function createRect(scene, x, y) {
          let rect = new RectangleView(100, 100);
          x = x || Math.random()*5000;
          y = y || Math.random()*5000;
          rect.setPickable(true);
          rect.setX(x);
          rect.setY(y);
          rect.setFillStyle("#FF0000");
          rect.setStrokeStyle("#000000");
          rect.setStrokeWidth(1);
          rect.addEventListener(MouseDownEvent.name, function(t, e) {
            rect.setFillStyle("purple");
          });
          scene.addView(rect);
        }
        
        let canvas = new Canvas("main-canvas");
        canvas.setFillStyle("black");
        
        let scene = canvas.addView(new SceneView());
        scene.position.x = 0;
        scene.position.y = 0;
        scene.size.x = canvas.getWidth() - 0;
        scene.size.y = canvas.getHeight() - 0;
        scene.clip = true;
        for (let i = 0; i < 500; ++i) { createRect(scene); }
        scene.addEventListener(MouseDownEvent.name, (t,e) => {
          let point = scene.localToChild(e.x, e.y);
          createRect(scene, point.x, point.y);
        });

        let player = scene.addView(new CircleView());
        const speed = 10;
        player.setRadius(20);
        player.setPickable(false);
        player.setFillStyle("blue");

        let dot = canvas.addView(new CircleView());
        dot.setPickable(false);
        dot.setFillStyle("lime");
        dot.setStrokeStyle(null);
        dot.setRadius(3);

        
        // ------------------------------
        function draw() {
          // Zoom, rotate
          if (Keyboard.isKeyDown("KeyR")) { // up
            scene.scale += 0.01;
          }
          if (Keyboard.isKeyDown("KeyF")) { // down
            scene.scale = Math.max(0.01, scene.scale - 0.01);
          }
          if (Keyboard.isKeyDown("KeyE")) { // rotate left
            scene.rotate(-Math.PI/180);
          }
          if (Keyboard.isKeyDown("KeyQ")) { // rotate right
            scene.rotate(Math.PI/180);
          }          

          // Translate
          let up    = new Vec2( 0, -1).rotate(-scene.rotation);
          let down  = new Vec2( 0,  1).rotate(-scene.rotation);
          let left  = new Vec2(-1,  0).rotate(-scene.rotation);
          let right = new Vec2( 1,  0).rotate(-scene.rotation);
          let total = new Vec2();
          
          if (Keyboard.isKeyDown("KeyW")) { // up
            total.add(up);
          }
          if (Keyboard.isKeyDown("KeyS")) { // down
            total.add(down);
          }
          if (Keyboard.isKeyDown("KeyA")) { // left
            total.add(left);
          }
          if (Keyboard.isKeyDown("KeyD")) { // right
            total.add(right);
          }
          total.setMag(speed);                    
          player.position.add(total);
          scene.centerOn(player.getX(), player.getY());
        
        
          // Point conversion
          let converted = scene.childToLocal(player.getX(), player.getY());
          dot.setX(converted.x);
          dot.setY(converted.y);
          
          
        
          // Draw
          canvas.draw();
          window.requestAnimationFrame(draw);
        }
        window.requestAnimationFrame(draw);
        
      });
    </script>  
  </body>

</html>